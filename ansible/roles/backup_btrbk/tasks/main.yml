---
# btrbk - btrfs snapshot management

- name: Install btrbk
  when: backup_btrbk_state == 'present'
  become: true
  block:
    - name: Install btrbk
      community.general.pacman:
        name: btrbk
        state: present

    - name: Mask shipped btrbk.service to prevent conflicts
      ansible.builtin.systemd_service:
        name: btrbk.service
        masked: true

    - name: Mask shipped btrbk.timer to prevent conflicts
      ansible.builtin.systemd_service:
        name: btrbk.timer
        masked: true

    - name: Ensure volume mounts are active
      ansible.builtin.systemd_service:
        name: "{{ item | to_systemd_mount_unit }}"
        state: started
      loop: "{{ backup_btrbk_jobs | map(attribute='volume_mount') | unique | list }}"

    - name: Create snapshot subvolumes
      community.general.btrfs_subvolume:
        name: snapshots
        filesystem_uuid: "{{ item | uuid_for_mount(ansible_facts['mounts']) }}"
        state: present
      loop: "{{ backup_btrbk_jobs | map(attribute='volume_mount') | unique | list }}"

    - name: Create btrbk configuration directory
      ansible.builtin.file:
        path: /etc/btrbk
        state: directory
        mode: "0755"

    - name: Deploy btrbk configurations
      ansible.builtin.template:
        src: btrbk-job.conf.j2
        dest: "/etc/btrbk/btrbk-{{ item.name }}.conf"
        mode: "0644"
      vars:
        job: "{{ item }}"
      loop: "{{ backup_btrbk_jobs }}"

    - name: Deploy btrbk service units
      ansible.builtin.template:
        src: btrbk-job.service.j2
        dest: "/etc/systemd/system/btrbk-{{ item.name }}.service"
        mode: "0644"
      vars:
        job: "{{ item }}"
      loop: "{{ backup_btrbk_jobs }}"
      notify: Systemd daemon-reload

    - name: Deploy btrbk timer units
      ansible.builtin.template:
        src: btrbk-job.timer.j2
        dest: "/etc/systemd/system/btrbk-{{ item.name }}.timer"
        mode: "0644"
      vars:
        job: "{{ item }}"
      loop: "{{ backup_btrbk_jobs }}"
      notify: Systemd daemon-reload

    - name: Deploy btrbk-update-current script
      ansible.builtin.copy:
        src: btrbk-update-current
        dest: /usr/local/bin/btrbk-update-current
        mode: "0755"

    - name: Flush handlers to reload systemd
      ansible.builtin.meta: flush_handlers

    - name: Enable and start btrbk timers
      ansible.builtin.systemd_service:
        name: "btrbk-{{ item.name }}.timer"
        state: started
        enabled: true
      loop: "{{ backup_btrbk_jobs }}"

    - name: Remove old single btrbk config if present
      ansible.builtin.file:
        path: /etc/btrbk/btrbk.conf
        state: absent

- name: Remove btrbk
  when: backup_btrbk_state == 'absent'
  become: true
  block:
    - name: Stop and disable btrbk timers
      ansible.builtin.systemd_service:
        name: "btrbk-{{ item.name }}.timer"
        state: stopped
        enabled: false
      loop: "{{ backup_btrbk_jobs }}"
      failed_when: false

    - name: Remove btrbk systemd units
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop: "{{ backup_btrbk_jobs | map(attribute='name')
               | map('regex_replace', '^(.*)$', '/etc/systemd/system/btrbk-\\1.service') | list
               + backup_btrbk_jobs | map(attribute='name')
               | map('regex_replace', '^(.*)$', '/etc/systemd/system/btrbk-\\1.timer') | list }}"
      notify: Systemd daemon-reload

    - name: Remove btrbk configurations
      ansible.builtin.file:
        path: "/etc/btrbk/btrbk-{{ item.name }}.conf"
        state: absent
      loop: "{{ backup_btrbk_jobs }}"

    - name: Remove btrbk-update-current script
      ansible.builtin.file:
        path: /usr/local/bin/btrbk-update-current
        state: absent

    - name: Unmask shipped btrbk services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        masked: false
      loop:
        - btrbk.service
        - btrbk.timer
      failed_when: false

    - name: Remove btrbk package
      community.general.pacman:
        name: btrbk
        state: absent
      failed_when: false
